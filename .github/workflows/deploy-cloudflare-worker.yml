name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
  pull_request:
    branches:
      - main

concurrency:
  group: cf-worker-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build for Cloudflare
        run: npm run cf:build

  deploy_production:
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build for Cloudflare
        run: npm run cf:build

      - name: Deploy to Cloudflare Workers
        run: npx wrangler deploy --config wrangler.jsonc
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy_preview:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build for Cloudflare
        run: npm run cf:build

      - name: Compute preview worker name
        id: preview_name
        run: |
          set -euo pipefail
          RAW="${GITHUB_REF_NAME,,}"
          SAFE="$(echo "$RAW" | sed -E 's#[/_\.]+#-#g; s#[^a-z0-9-]#-#g; s#-+#-#g; s#^-+##; s#-+$##')"
          if [ -z "$SAFE" ]; then
            SAFE="branch"
          fi
          SAFE="${SAFE:0:45}"
          WORKER_NAME="eatwhat-preview-${SAFE}"
          echo "worker_name=$WORKER_NAME" >> "$GITHUB_OUTPUT"

      - name: Deploy preview worker
        id: deploy_preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          npx wrangler deploy --config wrangler.jsonc --name "${{ steps.preview_name.outputs.worker_name }}" 2>&1 | tee deploy.log
          PREVIEW_URL="$(grep -Eo 'https://[^ ]+workers\.dev' deploy.log | tail -n 1 || true)"
          if [ -n "$PREVIEW_URL" ]; then
            echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync preview runtime secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WORKER_NAME: ${{ steps.preview_name.outputs.worker_name }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_STYLE: ${{ secrets.OPENAI_API_STYLE }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_RECOMMEND_MODEL: ${{ secrets.OPENAI_RECOMMEND_MODEL }}
          OPENAI_RECIPE_WEBSEARCH_MODEL: ${{ secrets.OPENAI_RECIPE_WEBSEARCH_MODEL }}
          OPENAI_STT_MODEL: ${{ secrets.OPENAI_STT_MODEL }}
          OPENAI_IMAGE_MODEL: ${{ secrets.OPENAI_IMAGE_MODEL }}
          OPENAI_IMAGE_SIZE: ${{ secrets.OPENAI_IMAGE_SIZE }}
          RECOMMEND_CACHE_TTL_SEC: ${{ secrets.RECOMMEND_CACHE_TTL_SEC }}
          SUPABASE_HISTORY_TABLE: ${{ secrets.SUPABASE_HISTORY_TABLE }}
        run: |
          set -euo pipefail

          REQUIRED_KEYS=(OPENAI_API_KEY SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY)
          MISSING_KEYS=()
          for KEY in "${REQUIRED_KEYS[@]}"; do
            if [ -z "${!KEY:-}" ]; then
              MISSING_KEYS+=("$KEY")
            fi
          done

          if [ "${#MISSING_KEYS[@]}" -gt 0 ]; then
            echo "Missing required GitHub secrets for preview runtime: ${MISSING_KEYS[*]}"
            exit 1
          fi

          ALL_KEYS=(
            OPENAI_API_KEY
            SUPABASE_URL
            SUPABASE_SERVICE_ROLE_KEY
            OPENAI_BASE_URL
            OPENAI_API_STYLE
            OPENAI_MODEL
            OPENAI_RECOMMEND_MODEL
            OPENAI_RECIPE_WEBSEARCH_MODEL
            OPENAI_STT_MODEL
            OPENAI_IMAGE_MODEL
            OPENAI_IMAGE_SIZE
            RECOMMEND_CACHE_TTL_SEC
            SUPABASE_HISTORY_TABLE
          )

          for KEY in "${ALL_KEYS[@]}"; do
            VALUE="${!KEY:-}"
            if [ -z "$VALUE" ]; then
              continue
            fi
            printf '%s' "$VALUE" | npx wrangler secret put "$KEY" --name "$WORKER_NAME" --config wrangler.jsonc >/dev/null
            echo "Synced secret: $KEY"
          done

      - name: Publish preview URL
        run: |
          URL="${{ steps.deploy_preview.outputs.preview_url }}"
          if [ -z "$URL" ]; then
            URL="https://${{ steps.preview_name.outputs.worker_name }}.workers.dev"
          fi
          {
            echo "### Preview Deployment"
            echo ""
            echo "- Branch: \`${GITHUB_REF_NAME}\`"
            echo "- Worker: \`${{ steps.preview_name.outputs.worker_name }}\`"
            echo "- URL: ${URL}"
          } >> "$GITHUB_STEP_SUMMARY"
